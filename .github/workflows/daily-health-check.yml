name: Daily Health Check

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run health check
        id: health
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get organization stats
          echo "## Daily Health Check - $(date '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          REPOS="jcaldwell-labs fintrack terminal-stars boxes-live atari-style .github my-context tario adventure-engine-v2 smartterm-prototype"

          total_prs=0
          total_issues=0

          echo "### Repository Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Open PRs | Open Issues | Last Activity |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|----------|-------------|---------------|" >> $GITHUB_STEP_SUMMARY

          for repo in $REPOS; do
            prs=$(gh pr list --repo jcaldwell-labs/$repo --state open --json number 2>/dev/null | jq 'length' || echo "0")
            issues=$(gh issue list --repo jcaldwell-labs/$repo --state open --json number 2>/dev/null | jq 'length' || echo "0")
            last_commit=$(gh api repos/jcaldwell-labs/$repo/commits --jq '.[0].commit.committer.date' 2>/dev/null | cut -d'T' -f1 || echo "N/A")

            total_prs=$((total_prs + prs))
            total_issues=$((total_issues + issues))

            echo "| $repo | $prs | $issues | $last_commit |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Open PRs:** $total_prs" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Open Issues:** $total_issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Set outputs for potential issue creation
          echo "total_prs=$total_prs" >> $GITHUB_OUTPUT
          echo "total_issues=$total_issues" >> $GITHUB_OUTPUT

      - name: Check CI status across repos
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### CI Status (Last 24h)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Status | Failed Runs |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|-------------|" >> $GITHUB_STEP_SUMMARY

          REPOS="jcaldwell-labs fintrack terminal-stars boxes-live atari-style my-context tario adventure-engine-v2 smartterm-prototype"

          for repo in $REPOS; do
            # Get workflow runs from last 24 hours
            runs=$(gh run list --repo jcaldwell-labs/$repo --limit 10 --json conclusion 2>/dev/null || echo "[]")
            failed=$(echo "$runs" | jq '[.[] | select(.conclusion == "failure")] | length')

            if [ "$failed" -gt 0 ]; then
              status="⚠️ Issues"
            else
              status="✅ OK"
            fi

            echo "| $repo | $status | $failed |" >> $GITHUB_STEP_SUMMARY
          done
